# SunnyCounselor 项目接口文档

## 项目概述
SunnyCounselor是一个心理咨询管理系统，包含两个主要应用：
- **CounselorAdmin**: 管理员后台系统
- **CounselorApp**: 咨询师工作台

## 基础信息
- **基础URL**: `http://127.0.0.1:8000/`
- **认证方式**: JWT Token认证
- **API版本**: v1

---

## CounselorAdmin 管理员接口

### 基础URL: `/admin/api/admin/`

### 1. 学生信息管理

#### GET /admin/api/admin/students/
**描述**: 获取学生列表

**查询参数**:
- `school`: 按学校筛选
- `grade`: 按年级筛选
- `class_name`: 按班级筛选
- `gender`: 按性别筛选
- `search`: 按姓名或学号搜索
- `ordering`: 排序字段 (created_at, updated_at, name)

**响应示例**:
```json
{
  "count": 2,
  "next": null,
  "previous": null,
  "results": [
    {
      "id": 1,
      "name": "学生1",
      "student_id": "20230001",
      "gender": "male",
      "age": 20,
      "grade": "大二",
      "class_name": "1班",
      "school": "测试大学",
      "phone": "",
      "emergency_contact": "",
      "emergency_phone": "",
      "created_at": "2025-10-20T10:00:00Z",
      "updated_at": "2025-10-20T10:00:00Z"
    }
  ]
}
```

#### POST /admin/api/admin/students/
**描述**: 创建学生信息

**请求体**:
```json
{
  "name": "新学生",
  "student_id": "20230003",
  "gender": "male",
  "age": 18,
  "grade": "大一",
  "class_name": "1班",
  "school": "测试大学",
  "phone": "13800138000",
  "emergency_contact": "家长",
  "emergency_phone": "13800138001"
}
```

**响应示例**:
```json
{
  "id": 3,
  "name": "新学生",
  "student_id": "20230003",
  "gender": "male",
  "age": 18,
  "grade": "大一",
  "class_name": "1班",
  "school": "测试大学",
  "phone": "13800138000",
  "emergency_contact": "家长",
  "emergency_phone": "13800138001",
  "created_at": "2025-10-21T12:00:00Z",
  "updated_at": "2025-10-21T12:00:00Z"
}
```

#### GET /admin/api/admin/students/{id}/
**描述**: 获取学生详情

**响应示例**:
```json
{
  "id": 1,
  "name": "学生1",
  "student_id": "20230001",
  "gender": "male",
  "age": 20,
  "grade": "大二",
  "class_name": "1班",
  "school": "测试大学",
  "phone": "",
  "emergency_contact": "",
  "emergency_phone": "",
  "created_at": "2025-10-20T10:00:00Z",
  "updated_at": "2025-10-20T10:00:00Z"
}
```

#### PUT /admin/api/admin/students/{id}/
**描述**: 更新学生信息

**请求体**:
```json
{
  "name": "更新学生",
  "student_id": "20230001",
  "gender": "male",
  "age": 21,
  "grade": "大三",
  "class_name": "1班",
  "school": "测试大学"
}
```

#### DELETE /admin/api/admin/students/{id}/
**描述**: 删除学生信息

**响应**: 204 No Content

#### POST /admin/api/admin/students/import_students/
**描述**: 批量导入学生信息

**请求体** (multipart/form-data):
- `file`: Excel文件

**响应示例**:
```json
{
  "message": "成功导入50名学生",
  "errors": []
}
```

#### GET /admin/api/admin/students/download_template/
**描述**: 下载导入模板

**查询参数**:
- `template_type`: 模板类型 (student_list)

### 2. 访谈记录管理

#### GET /admin/api/admin/interviews/
**描述**: 获取访谈记录列表

**查询参数**:
- `status`: 按状态筛选
- `assessment_level`: 按评估等级筛选
- `counselor`: 按咨询师ID筛选
- `student`: 按学生ID筛选
- `search`: 搜索学生姓名、咨询师姓名、访谈笔记

**响应示例**:
```json
{
  "count": 1,
  "next": null,
  "previous": null,
  "results": [
    {
      "id": 1,
      "student": 1,
      "student_name": "学生1",
      "counselor": 1,
      "counselor_name": "张老师",
      "interview_date": "2025-10-20T10:00:00Z",
      "status": "completed",
      "assessment_level": "low",
      "interview_notes": "学生反映学习压力大",
      "follow_up_plan": "建议减轻课业负担",
      "created_at": "2025-10-20T10:00:00Z",
      "updated_at": "2025-10-20T10:00:00Z"
    }
  ]
}
```

#### POST /admin/api/admin/interviews/
**描述**: 创建访谈记录

**请求体**:
```json
{
  "student": 1,
  "counselor": 1,
  "interview_date": "2025-10-21T10:00:00Z",
  "status": "pending",
  "assessment_level": "low",
  "interview_notes": "学生情绪稳定",
  "follow_up_plan": "定期回访"
}
```

#### POST /admin/api/admin/interviews/{id}/end_interview/
**描述**: 手动结束访谈

**响应示例**:
```json
{
  "message": "访谈已结束"
}
```

#### GET /admin/api/admin/interviews/statistics/
**描述**: 获取访谈统计信息

**响应示例**:
```json
{
  "total_interviews": 890,
  "completed_interviews": 750,
  "pending_interviews": 140,
  "high_risk_count": 120,
  "referral_count": 45
}
```

### 3. 负面事件管理

#### GET /admin/api/admin/negative-events/
**描述**: 获取负面事件列表

**查询参数**:
- `event_type`: 按事件类型筛选
- `severity`: 按严重程度筛选
- `is_resolved`: 按解决状态筛选
- `search`: 搜索学生姓名、事件描述

**响应示例**:
```json
[
  {
    "id": 1,
    "student": 1,
    "student_name": "学生1",
    "event_date": "2025-10-19",
    "event_type": "学业问题",
    "description": "期中考试不及格",
    "severity": "中等",
    "handling_measures": "安排补考和辅导",
    "follow_up_status": "进行中",
    "created_at": "2025-10-19T10:00:00Z"
  }
]
```

#### POST /admin/api/admin/negative-events/
**描述**: 创建负面事件记录

**请求体**:
```json
{
  "student": 1,
  "event_date": "2025-10-22",
  "event_type": "行为问题",
  "description": "课堂违纪",
  "severity": "轻微",
  "handling_measures": "口头警告",
  "follow_up_status": "已处理"
}
```

### 4. 转介管理

#### GET /admin/api/admin/referral-units/
**描述**: 获取转介单位列表

**响应示例**:
```json
[
  {
    "id": 1,
    "name": "阳光心理咨询中心",
    "unit_type": "psychology_center",
    "contact_person": "李主任",
    "phone": "010-12345678",
    "address": "北京市朝阳区某某路123号",
    "description": "专业心理咨询机构",
    "is_active": true,
    "created_at": "2025-01-01T00:00:00Z"
  }
]
```

#### GET /admin/api/admin/referral-histories/
**描述**: 获取转介历史记录

**响应示例**:
```json
[
  {
    "id": 1,
    "student": 1,
    "student_name": "学生1",
    "student_school": "测试大学",
    "student_grade": "大二",
    "student_class": "1班",
    "referral_unit": 1,
    "referral_unit_name": "阳光心理咨询中心",
    "reason": "需要专业心理治疗",
    "referral_date": "2025-10-15T10:00:00Z",
    "follow_up_notes": "已安排初次评估",
    "created_at": "2025-10-15T10:00:00Z"
  }
]
```

### 5. 宣教内容管理

#### GET /admin/api/admin/education-categories/
**描述**: 获取宣教栏目列表

**响应示例**:
```json
[
  {
    "id": 1,
    "name": "心理健康",
    "description": "心理健康相关知识",
    "order": 1,
    "is_active": true,
    "created_at": "2025-01-01T00:00:00Z"
  }
]
```

#### GET /admin/api/admin/education-contents/
**描述**: 获取宣教内容列表

**响应示例**:
```json
[
  {
    "id": 1,
    "category": 1,
    "category_name": "心理健康",
    "title": "如何应对学业压力",
    "content_type": "article",
    "content": "学业压力是学生常见的问题...",
    "thumbnail": "/media/education/thumbnails/压力管理.jpg",
    "view_count": 256,
    "is_published": true,
    "published_at": "2025-10-01T09:00:00Z",
    "created_at": "2025-09-28T14:00:00Z",
    "updated_at": "2025-10-01T09:00:00Z"
  }
]
```

#### POST /admin/api/admin/education-contents/{id}/publish/
**描述**: 发布宣教内容

**响应示例**:
```json
{
  "message": "内容已发布"
}
```

#### POST /admin/api/admin/education-contents/{id}/unpublish/
**描述**: 取消发布宣教内容

**响应示例**:
```json
{
  "message": "内容已取消发布"
}
```

### 6. 通知管理

#### GET /admin/api/admin/notifications/
**描述**: 获取通知列表

**响应示例**:
```json
[
  {
    "id": 1,
    "title": "系统维护通知",
    "content": "系统将于本周六进行维护...",
    "notification_type": "system",
    "status": "published",
    "target_audience": {"schools": ["阳光中学"]},
    "published_at": "2025-10-18T09:00:00Z",
    "created_at": "2025-10-17T14:00:00Z",
    "updated_at": "2025-10-18T09:00:00Z"
  }
]
```

### 7. 轮播图管理

#### GET /admin/api/admin/banners/
**描述**: 获取轮播图列表

**响应示例**:
```json
[
  {
    "id": 1,
    "title": "心理健康月活动",
    "image": "/media/banners/心理健康月.jpg",
    "link_url": "https://example.com/activity",
    "position": "home",
    "order": 1,
    "is_active": true,
    "start_date": "2025-10-01T00:00:00Z",
    "end_date": "2025-10-31T23:59:59Z",
    "created_at": "2025-09-28T10:00:00Z"
  }
]
```

### 8. 咨询师排班管理

#### GET /admin/api/admin/counselor-schedules/
**描述**: 获取咨询师排班列表

**响应示例**:
```json
[
  {
    "id": 1,
    "counselor": 1,
    "counselor_name": "王咨询师",
    "date": "2025-10-25",
    "start_time": "09:00:00",
    "end_time": "12:00:00",
    "is_available": true,
    "max_appointments": 5,
    "created_at": "2025-10-20T09:00:00Z"
  }
]
```

### 9. 咨询订单管理

#### GET /admin/api/admin/consultation-orders/
**描述**: 获取咨询订单列表

**响应示例**:
```json
[
  {
    "id": 1,
    "consultation": 1,
    "client_name": "张三",
    "counselor_name": "王咨询师",
    "consultation_type": "academic",
    "consultation_status": "completed",
    "scheduled_at": "2025-10-20T10:00:00Z",
    "order_number": "ORDER202510200001",
    "payment_status": "paid",
    "payment_amount": "200.00",
    "paid_at": "2025-10-20T10:30:00Z",
    "created_at": "2025-10-20T10:00:00Z"
  }
]
```

---

## CounselorApp 咨询师接口

### 基础URL: `/counselor/`

### 1. 首页和数据看板

#### GET /counselor/
**描述**: 咨询师工作台首页

**响应示例**:
```json
{
  "message": "欢迎访问咨询师工作台",
  "user": "counselor_username",
  "counselor": "测试咨询师"
}
```

#### GET /counselor/dashboard/stats/
**描述**: 数据看板统计信息

**响应示例**:
```json
{
  "today_stats": {
    "total": 15,
    "pending": 3,
    "in_progress": 5,
    "completed": 7
  },
  "yearly_total": 245,
  "type_distribution": [
    {"type": "academic", "count": 120},
    {"type": "emotional", "count": 80},
    {"type": "relationship", "count": 30},
    {"type": "career", "count": 15}
  ],
  "gender_distribution": [
    {"client__gender": "male", "count": 130},
    {"client__gender": "female", "count": 115}
  ],
  "age_distribution": [
    {"client__age": 18, "count": 45},
    {"client__age": 19, "count": 52},
    {"client__age": 20, "count": 48}
  ],
  "time_slot_distribution": [
    {"hour": "09:00-10:00", "count": 2},
    {"hour": "10:00-11:00", "count": 3},
    {"hour": "11:00-12:00", "count": 1},
    {"hour": "14:00-15:00", "count": 4},
    {"hour": "15:00-16:00", "count": 3},
    {"hour": "16:00-17:00", "count": 2}
  ],
  "average_rating": 4.8
}
```

### 2. 咨询管理

#### GET /counselor/consultations/pending/
**描述**: 待接单咨询列表

**响应示例**:
```json
[
  {
    "id": 1,
    "client": 101,
    "client_name": "张三",
    "client_gender": "male",
    "client_age": 20,
    "type": "academic",
    "status": "pending",
    "scheduled_at": "2025-10-21T14:00:00Z",
    "started_at": null,
    "ended_at": null,
    "description": "学业压力大，需要心理疏导",
    "notes": "",
    "created_at": "2025-10-20T10:00:00Z"
  }
]
```

#### GET /counselor/consultations/in-progress/
**描述**: 咨询中列表

**响应示例**:
```json
[
  {
    "id": 2,
    "client": 102,
    "client_name": "李四",
    "client_gender": "female",
    "client_age": 19,
    "type": "emotional",
    "status": "in_progress",
    "scheduled_at": "2025-10-20T15:00:00Z",
    "started_at": "2025-10-20T15:05:00Z",
    "ended_at": null,
    "description": "情感问题咨询",
    "notes": "正在进行中...",
    "created_at": "2025-10-19T09:00:00Z"
  }
]
```

#### GET /counselor/consultations/completed/
**描述**: 已结束咨询列表

**响应示例**:
```json
[
  {
    "id": 3,
    "client": 103,
    "client_name": "王五",
    "client_gender": "male",
    "client_age": 21,
    "type": "career",
    "status": "completed",
    "scheduled_at": "2025-10-19T10:00:00Z",
    "started_at": "2025-10-19T10:00:00Z",
    "ended_at": "2025-10-19T10:45:00Z",
    "description": "职业规划咨询",
    "notes": "咨询顺利完成，提供了职业建议",
    "created_at": "2025-10-18T14:00:00Z"
  }
]
```

#### GET /counselor/consultations/rejected/
**描述**: 已拒绝咨询列表

**响应示例**:
```json
[
  {
    "id": 4,
    "client": 104,
    "client_name": "赵六",
    "client_gender": "female",
    "client_age": 22,
    "type": "relationship",
    "status": "rejected",
    "scheduled_at": "2025-10-18T16:00:00Z",
    "started_at": null,
    "ended_at": null,
    "description": "人际关系问题",
    "notes": "",
    "created_at": "2025-10-17T11:00:00Z"
  }
]
```

#### POST /counselor/api/consultations/{id}/accept/
**描述**: 接受咨询

**响应示例**:
```json
{
  "message": "咨询已接受"
}
```

#### POST /counselor/api/consultations/{id}/reject/
**描述**: 拒绝咨询

**响应示例**:
```json
{
  "message": "咨询已拒绝"
}
```

#### POST /counselor/api/consultations/{id}/complete/
**描述**: 完成咨询

**响应示例**:
```json
{
  "message": "咨询已完成"
}
```

### 3. 排班管理

#### GET /counselor/api/schedules/
**描述**: 获取排班列表

**响应示例**:
```json
[
  {
    "id": 1,
    "date": "2025-10-21",
    "start_time": "09:00:00",
    "end_time": "12:00:00",
    "is_available": true,
    "reason": ""
  },
  {
    "id": 2,
    "date": "2025-10-21",
    "start_time": "14:00:00",
    "end_time": "17:00:00",
    "is_available": true,
    "reason": ""
  }
]
```

#### POST /counselor/schedules/bulk-create/
**描述**: 批量创建排班

**请求体**:
```json
{
  "dates": ["2025-10-23", "2025-10-24", "2025-10-25"],
  "start_time": "09:00:00",
  "end_time": "12:00:00"
}
```

**响应示例**:
```json
{
  "message": "成功创建 3 个排班",
  "schedules": [
    {
      "id": 3,
      "date": "2025-10-23",
      "start_time": "09:00:00",
      "end_time": "12:00:00",
      "is_available": true,
      "reason": ""
    }
  ]
}
```

#### POST /counselor/schedules/stop-service/
**描述**: 添加停诊安排

**请求体**:
```json
{
  "date": "2025-10-26",
  "reason": "参加培训会议"
}
```

**响应示例**:
```json
{
  "message": "已停诊 2 个排班",
  "date": "2025-10-26",
  "reason": "参加培训会议"
}
```

### 4. 评论管理

#### GET /counselor/api/reviews/
**描述**: 获取评论列表

**响应示例**:
```json
[
  {
    "id": 1,
    "client_name": "张三",
    "rating": 5,
    "comment": "咨询师非常专业，解答了我的困惑",
    "is_anonymous": false,
    "created_at": "2025-10-19T11:00:00Z"
  },
  {
    "id": 2,
    "client_name": "匿名用户",
    "rating": 4,
    "comment": "服务态度很好",
    "is_anonymous": true,
    "created_at": "2025-10-18T15:30:00Z"
  }
]
```

### 5. 个人资料管理

#### GET /counselor/profile/
**描述**: 获取个人资料

**响应示例**:
```json
{
  "id": 1,
  "name": "测试咨询师",
  "gender": "male",
  "age": 35,
  "phone": "13800138000",
  "email": "counselor@test.com",
  "avatar": null,
  "service_types": ["academic", "emotional"],
  "introduction": "",
  "years_of_experience": 5
}
```

#### PUT /counselor/profile/update/
**描述**: 更新个人资料

**请求体**:
```json
{
  "name": "更新后的咨询师",
  "phone": "13800138001",
  "introduction": "资深心理咨询师，10年从业经验",
  "years_of_experience": 11
}
```

#### PUT /counselor/profile/service-types/
**描述**: 更新服务类型配置

**请求体**:
```json
{
  "service_types": ["academic", "emotional", "career"]
}
```

## 错误响应格式

### 通用错误格式
```json
{
  "error": "错误描述信息",
  "code": "错误代码（可选）"
}
```

### 常见错误码
- `400`: 请求参数错误
- `401`: 未认证
- `403`: 权限不足
- `404`: 资源不存在
- `409`: 资源冲突
- `500`: 服务器内部错误

## 权限说明

### CounselorAdmin 权限要求
- 所有接口都需要管理员权限 (`IsAdminUser`)
- 支持完整的CRUD操作
- 可以访问所有数据

### CounselorApp 权限要求
- 所有接口都需要咨询师权限 (`CounselorPermission`)
- 数据隔离：每个咨询师只能访问自己的数据
- 只能操作自己相关的咨询、排班、评论等

## 认证方式
- 使用JWT Token认证
- 需要在请求头中添加：`Authorization: Bearer {token}`
- Token可以通过登录接口获取

---

*文档生成时间: 2025-10-21*
*项目版本: v1.0.0*