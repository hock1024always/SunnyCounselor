# 服务器部署文档

本文档详细说明如何在服务器上部署和配置心理咨询管理系统。

## ⚠️ 快速修复指南

### 问题1：ModuleNotFoundError: No module named 'Consultant'

如果遇到 `ModuleNotFoundError: No module named 'Consultant'` 错误，说明 `Consultant/` 应用目录未上传到服务器。

**快速解决方案**：

1. **在本地Windows PowerShell中执行**（替换为实际的服务器IP）：
```powershell
scp -r D:\github\SunnyCounselor\DjangoProject\Consultant root@your-server-ip:/root/counselor/controller/
```

2. **在服务器上验证**：
```bash
cd /root/counselor/controller
ls -la Consultant/
```

3. **重新执行迁移**：
```bash
python manage.py makemigrations
python manage.py migrate
```

详细的问题排查步骤请参考 **十二、常见问题排查 > 12.6** 节。

---

### 问题2：APIfox/Postman 无法访问服务器接口

如果Django服务器已启动，但APIfox无法访问，通常是服务器绑定地址错误。

**快速解决方案**：

1. **停止当前服务器**（在服务器终端按 `Ctrl+C`）

2. **使用正确的命令重新启动**：
```bash
python manage.py runserver 0.0.0.0:8000
```

3. **获取服务器公网IP**：
```bash
curl ifconfig.me
```

4. **在APIfox中使用**：`http://<公网IP>:8000`

5. **如果仍无法访问，检查防火墙**：
```bash
# Ubuntu/Debian
sudo ufw allow 8000/tcp

# CentOS
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --reload
```

6. **检查云服务器安全组**：在云服务器控制台（阿里云、腾讯云等）中开放8000端口。

详细的问题排查步骤请参考 **十二、常见问题排查 > 12.7** 节。

---

### 问题3：OperationalError: no such table: verification_codes

如果访问API时出现表不存在的错误，说明数据库迁移未执行。

**快速解决方案**：

1. **执行数据库迁移**：
```bash
cd /root/counselor/controller
source venv/bin/activate
python manage.py migrate
```

2. **验证迁移成功**：
```bash
python manage.py showmigrations
sqlite3 db.sqlite3 ".tables" | grep verification_codes
```

3. **重启服务器**：
```bash
python manage.py runserver 0.0.0.0:8000
```

详细的问题排查步骤请参考 **十二、常见问题排查 > 12.8** 节。

---

### 问题4：如何让程序在后台持久运行？

**快速解决方案**（推荐使用 systemd）：

1. **安装 Gunicorn**：
```bash
cd /root/counselor/controller
source venv/bin/activate
pip install gunicorn
```

2. **创建 systemd 服务文件**：
```bash
sudo nano /etc/systemd/system/django-counselor.service
```

3. **配置服务**（参考 **七、运行项目 > 7.3** 节）

4. **启动服务**：
```bash
sudo systemctl daemon-reload
sudo systemctl start django-counselor
sudo systemctl enable django-counselor  # 开机自启
```

**简单方法**（快速测试）：
```bash
# 使用 nohup 后台运行
nohup python manage.py runserver 0.0.0.0:8000 > logs/django.log 2>&1 &
```

详细的持久化运行方案请参考 **七、运行项目 > 7.3 持久化运行** 节。

---

## 一、环境要求

### 1.1 系统要求
- **操作系统**: Linux (Ubuntu 20.04/22.04 推荐) 或 CentOS 7+
- **Python版本**: Python 3.8 或更高版本 (推荐 Python 3.9+)
- **数据库**: SQLite3 (默认) 或 PostgreSQL/MySQL (生产环境推荐)

### 1.2 Python依赖
所有依赖包已列在 `requirements.txt` 文件中，包括：
- Django 4.2.7
- Django REST Framework 3.14.0
- django-cors-headers 4.3.1
- pandas, openpyxl (用于Excel文件处理)
- Pillow (用于图片处理)
- 其他依赖项

## 二、服务器环境配置

### 2.1 安装Python和pip

```bash
# Ubuntu/Debian系统
sudo apt update
sudo apt install python3 python3-pip python3-venv -y

# CentOS系统
sudo yum install python3 python3-pip -y
```

### 2.2 创建Python虚拟环境（推荐）

```bash
# 进入项目目录
cd /path/to/DjangoProject

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows (如果需要在Windows服务器上部署)
```

### 2.3 安装项目依赖

```bash
# 确保在虚拟环境中
pip install --upgrade pip
pip install -r requirements.txt
```

## 三、项目代码部署

### 3.1 重要说明

**Django项目不需要编译，直接上传源代码即可。**

项目使用Python解释型语言，服务器上的Python环境会直接运行源代码，无需预先编译。

### 3.2 上传项目代码到服务器

有多种方式可以将项目代码上传到服务器，推荐使用以下方法：

#### 方法一：使用Git（推荐）

如果项目已托管到Git仓库（如GitHub、GitLab等），在服务器上直接克隆：

```bash
# 进入目标目录（如 /root/counselor/controller）
cd /root/counselor/controller

# 克隆项目（替换为实际的仓库地址）
git clone <your-repository-url> .

# 或者如果已有目录，进入后克隆
# cd /root/counselor/controller
# git clone <your-repository-url> temp
# mv temp/* temp/.* . 2>/dev/null || true
# rmdir temp
```

#### 方法二：使用SCP命令（从本地Windows上传）

在本地Windows PowerShell或CMD中执行：

```powershell
# 使用SCP上传整个项目目录
# 语法：scp -r <本地目录> <用户名>@<服务器IP>:<目标路径>

# 示例（替换为实际值）
scp -r D:\github\SunnyCounselor\DjangoProject\* root@your-server-ip:/root/counselor/controller/
```

如果使用SSH密钥，需要指定密钥路径：
```powershell
scp -i C:\path\to\your\key.pem -r D:\github\SunnyCounselor\DjangoProject\* root@your-server-ip:/root/counselor/controller/
```

#### 方法三：使用FTP/SFTP工具

使用WinSCP、FileZilla等图形化工具上传项目文件。

**上传时需要包含以下文件和目录：**
- `manage.py` - Django项目管理脚本（必需）
- `requirements.txt` - Python依赖列表（必需）
- `DjangoProject/` - 项目主配置目录（必需）
- `CounselorAdmin/` - 管理员应用目录（必需）
- `Consultant/` - 咨询师应用目录（必需）
- `templates/` - 模板文件目录（如果存在）
- `static/` - 静态文件目录（如果本地已有文件需要上传）
- `.git/` - Git仓库目录（可选，如果使用Git）

**不需要上传的内容：**
- `venv/` - 虚拟环境（在服务器上重新创建）
- `__pycache__/` - Python缓存文件（可忽略）
- `*.pyc` - Python编译文件（可忽略）
- `db.sqlite3` - 本地数据库文件（服务器上会创建新的）
- `.idea/` - IDE配置文件（可忽略）
- `counselor/` - 本地虚拟环境目录（可忽略）

### 3.3 验证项目文件结构

上传完成后，在服务器上验证项目结构：

```bash
# 进入项目目录
cd /root/counselor/controller

# 查看项目文件
ls -la

# 应该能看到以下关键文件/目录：
# - manage.py
# - requirements.txt
# - DjangoProject/
# - CounselorAdmin/
# - Consultant/
# - static/（如果已创建）
# - templates/（如果已创建）
# - venv/（虚拟环境）
```

**检查关键文件是否存在：**
```bash
# 检查manage.py
ls -l manage.py

# 检查项目配置目录
ls -la DjangoProject/

# 检查应用目录（两个应用都必须存在）
ls -la CounselorAdmin/
ls -la Consultant/

# 验证应用目录结构完整
ls -la Consultant/apps.py
ls -la Consultant/models.py
ls -la Consultant/__init__.py
ls -la CounselorAdmin/apps.py
ls -la CounselorAdmin/models.py
ls -la CounselorAdmin/__init__.py
```

### 3.4 项目目录权限设置

确保项目文件有正确的权限：

```bash
# 进入项目根目录
cd /root/counselor/controller

# 设置项目文件权限（可读可执行）
find . -type f -name "*.py" -exec chmod 644 {} \;
find . -type f -name "manage.py" -exec chmod 755 {} \;

# 设置目录权限
find . -type d -exec chmod 755 {} \;
```

### 3.5 常见问题

**问题1：上传后发现缺少某些文件**
- 检查本地项目目录是否完整
- 确认上传时使用了递归选项（`-r`）
- 检查是否有文件被.gitignore排除（如需要，可临时取消忽略）

**问题2：上传后文件权限不正确**
- 使用 `chmod` 命令修正权限（见3.4节）

**问题3：上传了不需要的 `__pycache__` 缓存目录**
- `__pycache__` 目录是Python自动生成的缓存，可以安全删除：
```bash
# 进入项目根目录
cd /root/counselor/controller

# 删除所有 __pycache__ 目录和 .pyc 文件
find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete
find . -type f -name "*.pyo" -delete

# 验证是否已删除
find . -name "__pycache__" -o -name "*.pyc"
# 如果没有输出，说明已全部删除
```
- **注意**：删除这些文件不会影响项目运行，Python会在运行时自动重新生成

**问题4：项目文件太大，上传慢**
- 可以先压缩项目文件，上传后再解压：
```bash
# 本地压缩（排除不需要的文件）
# 在项目根目录（DjangoProject目录的父目录）执行
cd D:\github\SunnyCounselor
tar -czf project.tar.gz --exclude='venv' --exclude='__pycache__' --exclude='*.pyc' --exclude='.git' --exclude='counselor' --exclude='db.sqlite3' --exclude='*.pyc' DjangoProject/

# 注意：确保压缩包包含 Consultant/ 和 CounselorAdmin/ 目录
# 解压后验证：
# tar -tzf project.tar.gz | grep -E "Consultant|CounselorAdmin"

# 上传压缩包
scp project.tar.gz root@your-server-ip:/root/counselor/controller/

# 服务器上解压
cd /root/counselor/controller
tar -xzf project.tar.gz
# 解压后文件会在DjangoProject目录中，需要移动到当前目录
mv DjangoProject/* . 2>/dev/null || true
rmdir DjangoProject 2>/dev/null || true
```

**或者使用Windows的压缩工具：**
- 使用7-Zip或WinRAR压缩项目目录（排除不需要的文件）
- 使用WinSCP等工具上传压缩包
- 在服务器上使用 `unzip` 或 `tar -xzf` 解压

## 四、项目配置

### 4.1 配置数据库

#### SQLite3 (默认，开发测试环境)
无需额外配置，Django会自动创建 `db.sqlite3` 文件。

#### PostgreSQL (生产环境推荐)
如需使用PostgreSQL，修改 `DjangoProject/settings.py`:

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'your_db_name',
        'USER': 'your_db_user',
        'PASSWORD': 'your_db_password',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
```

安装PostgreSQL适配器：
```bash
pip install psycopg2-binary
```

#### MySQL (可选)
如需使用MySQL，修改 `DjangoProject/settings.py`:

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'your_db_name',
        'USER': 'your_db_user',
        'PASSWORD': 'your_db_password',
        'HOST': 'localhost',
        'PORT': '3306',
    }
}
```

安装MySQL适配器：
```bash
pip install mysqlclient
```

### 4.2 执行数据库迁移

**⚠️ 重要提示**：在执行迁移之前，请确保所有应用目录（`Consultant/` 和 `CounselorAdmin/`）都已正确上传到服务器。

```bash
# 进入项目根目录
cd /root/counselor/controller

# 验证应用目录存在
ls -la Consultant/ CounselorAdmin/

# 创建迁移文件（如果还没有）
python manage.py makemigrations

# 如果出现 ModuleNotFoundError，请参考 12.6 节排查问题

# 应用迁移（创建所有数据库表）
python manage.py migrate

# 查看迁移状态（可选）
python manage.py showmigrations
```

**迁移说明**：
- `makemigrations`：根据模型变化生成迁移文件（如果模型有变化）
- `migrate`：将迁移应用到数据库，创建或更新数据库表
- 两个应用（`Consultant` 和 `CounselorAdmin`）的表都会被创建

**验证迁移是否成功**：
```bash
# 检查数据库文件是否存在
ls -lh db.sqlite3

# 使用Django shell检查表是否存在（可选）
python manage.py shell
# 在shell中执行：
# from django.db import connection
# tables = connection.introspection.table_names()
# print('verification_codes' in tables)
# exit()
```

### 4.3 创建超级管理员账户（可选）

```bash
python manage.py createsuperuser
```

## 五、静态文件和上传文件目录配置

### 5.1 重要目录说明

项目使用两个目录来管理静态资源：

1. **`static/` 目录**（`STATICFILES_DIRS`）:
   - 用于存储**上传的文件**（用户上传的图片、视频、Excel等）
   - 包含以下子目录：
     - `static/interview_form/` - 批量导入的访谈记录Excel文件
     - `static/referral_image/` - 转介管理的图片文件
     - `static/article_video/` - 教育管理的视频文件
     - `static/banner_photo/` - 轮播图图片文件
   - **注意**: 这个目录需要在服务器上手动创建并确保有写权限

2. **`staticfiles/` 目录**（`STATIC_ROOT`）:
   - 用于Django收集静态文件（`collectstatic`命令）
   - 生产环境通过Nginx等服务直接提供静态文件服务

### 5.2 创建必要的目录

```bash
# 进入项目根目录
cd /path/to/DjangoProject

# 创建static目录（如果不存在）
mkdir -p static

# 创建各个上传文件子目录
mkdir -p static/interview_form
mkdir -p static/referral_image
mkdir -p static/article_video
mkdir -p static/banner_photo
mkdir -p templates  # 模板文件目录（已存在可跳过）

# 设置目录权限（确保Django进程有写权限）
chmod -R 755 static
chmod -R 755 templates

# 如果使用特定的用户运行Django，设置所有权
# sudo chown -R www-data:www-data static templates  # Ubuntu/Debian
# sudo chown -R nginx:nginx static templates  # CentOS
```

### 5.3 收集静态文件（生产环境）

```bash
# 收集静态文件到staticfiles目录（用于Nginx等Web服务器）
python manage.py collectstatic --noinput
```

## 六、CORS和ALLOWED_HOSTS配置

### 6.1 当前配置说明

为了便于前端测试，当前配置已设置为：

```python
# settings.py

# 允许所有主机访问
ALLOWED_HOSTS = ['*']

# CORS配置 - 允许所有来源
CORS_ALLOW_ALL_ORIGINS = True
CORS_ALLOW_METHODS = ['DELETE', 'GET', 'OPTIONS', 'PATCH', 'POST', 'PUT']
```

### 6.2 生产环境安全建议

**⚠️ 安全警告**: 当前配置允许所有IP访问，仅适用于测试环境。

生产环境建议：

```python
# 限制允许的主机
ALLOWED_HOSTS = ['your-domain.com', 'www.your-domain.com', 'your-server-ip']

# 限制CORS来源
CORS_ALLOW_ALL_ORIGINS = False
CORS_ALLOWED_ORIGINS = [
    "https://your-frontend-domain.com",
    "http://localhost:3000",  # 开发环境
]
```

## 七、运行项目

### 7.1 开发模式运行

**⚠️ 重要提示**：如果要允许外部访问（如使用APIfox、Postman等工具测试），必须使用 `0.0.0.0` 而不是 `127.0.0.1`。

```bash
# 激活虚拟环境（如果使用）
source venv/bin/activate

# 运行开发服务器（允许外部访问）
python manage.py runserver 0.0.0.0:8000

# 或者指定端口
python manage.py runserver 0.0.0.0:8001
```

**常见错误**：
- ❌ `python manage.py runserver` - 默认绑定到 `127.0.0.1:8000`，只能从服务器本机访问
- ✅ `python manage.py runserver 0.0.0.0:8000` - 绑定到所有网络接口，允许外部访问

**访问地址**：
- 服务器本机访问：`http://127.0.0.1:8000` 或 `http://localhost:8000`
- 外部访问（APIfox等工具）：`http://<服务器公网IP>:8000`
  - 例如：`http://47.xxx.xxx.xxx:8000`

**获取服务器IP地址**：
```bash
# 查看公网IP
curl ifconfig.me
# 或
curl ip.sb

# 查看内网IP
ip addr show
# 或
ifconfig
```

### 7.2 生产环境部署（使用Gunicorn）

#### 7.2.1 安装Gunicorn

```bash
pip install gunicorn
```

#### 7.2.2 创建Gunicorn配置文件

创建 `gunicorn_config.py`:

```python
# gunicorn_config.py
bind = "0.0.0.0:8000"
workers = 4
worker_class = "sync"
worker_connections = 1000
timeout = 30
keepalive = 2
max_requests = 1000
max_requests_jitter = 50
```

#### 7.2.3 使用Gunicorn启动

```bash
# 直接运行
gunicorn DjangoProject.wsgi:application -c gunicorn_config.py

# 或使用systemd管理（见下方）
```

### 7.3 持久化运行（后台运行）

有多种方式可以让Django应用在后台持续运行，推荐使用 **systemd**（生产环境）或 **nohup/screen**（快速测试）。

---

#### 方法一：使用 systemd（推荐，生产环境）

systemd 是 Linux 系统的服务管理器，可以确保服务在后台运行、自动重启、开机自启等。

##### 7.3.1 安装 Gunicorn（如果还没安装）

```bash
# 激活虚拟环境
source venv/bin/activate

# 安装 Gunicorn
pip install gunicorn
```

##### 7.3.2 创建 Gunicorn 配置文件

在项目根目录创建 `gunicorn_config.py`：

```bash
cd /root/counselor/controller
nano gunicorn_config.py
```

添加以下内容：

```python
# gunicorn_config.py
bind = "0.0.0.0:8000"
workers = 4
worker_class = "sync"
worker_connections = 1000
timeout = 30
keepalive = 2
max_requests = 1000
max_requests_jitter = 50
accesslog = "/root/counselor/controller/logs/gunicorn_access.log"
errorlog = "/root/counselor/controller/logs/gunicorn_error.log"
loglevel = "info"
```

创建日志目录：

```bash
mkdir -p logs
chmod 755 logs
```

##### 7.3.3 创建 systemd 服务文件

```bash
sudo nano /etc/systemd/system/django-counselor.service
```

添加以下内容（**注意替换实际路径**）：

```ini
[Unit]
Description=Django Counselor Admin Service
After=network.target

[Service]
Type=notify
User=root  # 根据实际情况修改，如果使用root用户运行则保持root
Group=root  # 根据实际情况修改
WorkingDirectory=/root/counselor/controller
Environment="PATH=/root/counselor/controller/venv/bin"
ExecStart=/root/counselor/controller/venv/bin/gunicorn DjangoProject.wsgi:application -c /root/counselor/controller/gunicorn_config.py
Restart=always
RestartSec=3
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

**重要提示**：请将以下路径替换为你的实际路径：
- `WorkingDirectory`: 项目根目录（包含 `manage.py` 的目录）
- `Environment PATH`: 虚拟环境的 `bin` 目录
- `ExecStart`: Gunicorn 的完整路径和配置文件路径

##### 7.3.4 启动和管理服务

```bash
# 1. 重新加载 systemd 配置
sudo systemctl daemon-reload

# 2. 启动服务
sudo systemctl start django-counselor

# 3. 设置开机自启
sudo systemctl enable django-counselor

# 4. 查看服务状态
sudo systemctl status django-counselor

# 5. 查看实时日志
sudo journalctl -u django-counselor -f

# 6. 停止服务
sudo systemctl stop django-counselor

# 7. 重启服务
sudo systemctl restart django-counselor

# 8. 查看服务是否开机自启
sudo systemctl is-enabled django-counselor
```

**验证服务运行**：

```bash
# 检查进程是否运行
ps aux | grep gunicorn

# 检查端口是否被监听
sudo netstat -tulpn | grep 8000

# 测试访问
curl http://127.0.0.1:8000
```

---

#### 方法二：使用 nohup（简单快速，适合测试）

适合快速测试，但不推荐生产环境使用。

```bash
# 进入项目目录
cd /root/counselor/controller

# 激活虚拟环境
source venv/bin/activate

# 使用 nohup 后台运行（开发服务器）
nohup python manage.py runserver 0.0.0.0:8000 > logs/django.log 2>&1 &

# 或者使用 Gunicorn
nohup gunicorn DjangoProject.wsgi:application -c gunicorn_config.py > logs/gunicorn.log 2>&1 &

# 查看进程
ps aux | grep -E "runserver|gunicorn"

# 查看日志
tail -f logs/django.log

# 停止进程（需要先找到进程ID）
ps aux | grep runserver
kill <PID>  # 替换为实际的进程ID
```

---

#### 方法三：使用 screen（适合临时测试）

适合需要交互式操作的场景。

```bash
# 安装 screen（如果没有）
sudo apt install screen -y  # Ubuntu/Debian
sudo yum install screen -y  # CentOS

# 创建新的 screen 会话
screen -S django

# 在 screen 中启动服务
cd /root/counselor/controller
source venv/bin/activate
python manage.py runserver 0.0.0.0:8000

# 按 Ctrl+A 然后按 D 来分离会话（服务继续运行）

# 重新连接到会话
screen -r django

# 查看所有 screen 会话
screen -ls

# 终止会话
screen -X -S django quit
```

---

#### 方法四：使用 supervisor（替代 systemd）

如果系统没有 systemd 或需要更细粒度的控制，可以使用 supervisor。

```bash
# 安装 supervisor
sudo apt install supervisor -y  # Ubuntu/Debian
sudo yum install supervisor -y  # CentOS

# 创建配置文件
sudo nano /etc/supervisor/conf.d/django-counselor.conf
```

添加以下内容：

```ini
[program:django-counselor]
command=/root/counselor/controller/venv/bin/gunicorn DjangoProject.wsgi:application -c /root/counselor/controller/gunicorn_config.py
directory=/root/counselor/controller
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/root/counselor/controller/logs/supervisor.log
```

启动 supervisor：

```bash
# 重新加载配置
sudo supervisorctl reread
sudo supervisorctl update

# 启动服务
sudo supervisorctl start django-counselor

# 查看状态
sudo supervisorctl status

# 查看日志
sudo supervisorctl tail -f django-counselor
```

---

### 7.4 推荐方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **systemd** | 系统级服务，自动重启，开机自启，日志管理完善 | 需要 root 权限，配置稍复杂 | **生产环境推荐** |
| **nohup** | 简单快速，无需额外配置 | 进程管理不便，无自动重启 | 快速测试 |
| **screen** | 可交互，便于调试 | 需要手动管理，无自动重启 | 临时测试 |
| **supervisor** | 功能强大，进程管理完善 | 需要额外安装，配置较复杂 | systemd 不可用时 |

**生产环境强烈推荐使用 systemd**。

## 八、Nginx配置（生产环境推荐）

### 8.1 安装Nginx

```bash
# Ubuntu/Debian
sudo apt install nginx -y

# CentOS
sudo yum install nginx -y
```

### 8.2 配置Nginx

创建 `/etc/nginx/sites-available/django-counselor` (Ubuntu/Debian) 或 `/etc/nginx/conf.d/django-counselor.conf` (CentOS):

```nginx
upstream django_app {
    server 127.0.0.1:8000;  # Gunicorn监听地址
    keepalive 64;
}

server {
    listen 80;
    server_name your-domain.com www.your-domain.com;  # 替换为实际域名

    # 客户端上传文件大小限制（根据需要调整）
    client_max_body_size 100M;

    # 静态文件服务（上传的文件）
    location /static/ {
        alias /path/to/DjangoProject/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Django收集的静态文件（如果使用了collectstatic）
    location /staticfiles/ {
        alias /path/to/DjangoProject/staticfiles/;
        expires 30d;
    }

    # 反向代理到Django应用
    location / {
        proxy_pass http://django_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        
        # WebSocket支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 8.3 启用配置并重启Nginx

```bash
# Ubuntu/Debian - 创建软链接
sudo ln -s /etc/nginx/sites-available/django-counselor /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 设置开机自启
sudo systemctl enable nginx
```

## 九、防火墙配置

### 9.1 Ubuntu/Debian (UFW)

```bash
# 允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 如果直接使用Django开发服务器（不推荐生产环境）
sudo ufw allow 8000/tcp

# 启用防火墙
sudo ufw enable
```

### 9.2 CentOS (firewalld)

```bash
# 允许HTTP和HTTPS
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https

# 如果直接使用Django开发服务器
sudo firewall-cmd --permanent --add-port=8000/tcp

# 重新加载防火墙规则
sudo firewall-cmd --reload
```

## 十、SSL/HTTPS配置（生产环境必需）

### 10.1 使用Let's Encrypt免费证书

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y  # Ubuntu/Debian
sudo yum install certbot python3-certbot-nginx -y  # CentOS

# 获取证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 自动续期测试
sudo certbot renew --dry-run
```

## 十一、日志管理

### 11.1 Django日志配置

在 `DjangoProject/settings.py` 中添加日志配置（生产环境推荐）：

```python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'logs', 'django.log'),
            'formatter': 'verbose',
        },
        'error_file': {
            'level': 'ERROR',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'logs', 'django_error.log'),
            'formatter': 'verbose',
        },
    },
    'root': {
        'handlers': ['file', 'error_file'],
        'level': 'INFO',
    },
    'loggers': {
        'django': {
            'handlers': ['file', 'error_file'],
            'level': 'INFO',
            'propagate': False,
        },
    },
}
```

创建日志目录：
```bash
mkdir -p logs
chmod 755 logs
```

### 11.2 日志查看

```bash
# Django应用日志
tail -f /path/to/DjangoProject/logs/django.log
tail -f /path/to/DjangoProject/logs/django_error.log

# Nginx访问日志
tail -f /var/log/nginx/access.log

# Nginx错误日志
tail -f /var/log/nginx/error.log

# systemd服务日志
sudo journalctl -u django-counselor -f
```

## 十二、常见问题排查

### 12.1 静态文件无法访问

1. 检查目录权限：
```bash
ls -la static/
chmod -R 755 static/
```

2. 检查Nginx配置中的路径是否正确

3. 检查URL配置是否正确加载了静态文件路由

### 12.2 CORS跨域问题

1. 确认 `django-cors-headers` 已安装：`pip list | grep django-cors-headers`

2. 确认中间件配置正确（在 `settings.py` 中）

3. 检查CORS配置是否允许了前端域名

### 12.3 文件上传失败

1. 检查上传目录是否存在且有写权限：
```bash
ls -la static/referral_image/
chmod -R 755 static/
```

2. 检查Nginx的 `client_max_body_size` 设置

3. 检查Django的 `FILE_UPLOAD_MAX_MEMORY_SIZE` 设置（默认2.5MB）

### 12.4 数据库连接问题

1. 检查数据库文件权限（SQLite）：
```bash
chmod 664 db.sqlite3
chmod 775 .  # 目录权限
```

2. PostgreSQL/MySQL连接问题：检查用户名、密码、主机、端口

### 12.5 端口被占用

```bash
# 查找占用端口的进程
sudo lsof -i :8000
sudo netstat -tulpn | grep 8000

# 杀死进程
sudo kill -9 <PID>
```

### 12.6 ModuleNotFoundError: No module named 'Consultant' 或 'CounselorAdmin'

**问题描述**：执行 `python manage.py makemigrations` 或 `python manage.py migrate` 时出现模块找不到的错误。

**原因**：应用目录（`Consultant/` 或 `CounselorAdmin/`）未上传到服务器，或目录结构不完整。

**解决方案**：

1. **检查应用目录是否存在**：
```bash
# 进入项目根目录
cd /root/counselor/controller

# 检查两个应用目录是否存在
ls -la | grep -E "Consultant|CounselorAdmin"

# 如果缺少某个目录，需要重新上传
```

2. **如果缺少 `Consultant/` 目录**：
```bash
# 从本地重新上传 Consultant 目录
# 在本地Windows PowerShell中执行：
scp -r D:\github\SunnyCounselor\DjangoProject\Consultant root@your-server-ip:/root/counselor/controller/
```

3. **如果缺少 `CounselorAdmin/` 目录**：
```bash
# 从本地重新上传 CounselorAdmin 目录
# 在本地Windows PowerShell中执行：
scp -r D:\github\SunnyCounselor\DjangoProject\CounselorAdmin root@your-server-ip:/root/counselor/controller/
```

4. **验证应用目录结构完整**：
```bash
# 检查 Consultant 目录结构
ls -la Consultant/
# 应该包含：__init__.py, apps.py, models.py, views/, urls.py 等

# 检查 CounselorAdmin 目录结构
ls -la CounselorAdmin/
# 应该包含：__init__.py, apps.py, models.py, views/, urls.py 等

# 特别检查关键文件是否存在
test -f Consultant/__init__.py && echo "Consultant/__init__.py 存在" || echo "Consultant/__init__.py 不存在"
test -f Consultant/apps.py && echo "Consultant/apps.py 存在" || echo "Consultant/apps.py 不存在"
test -f CounselorAdmin/__init__.py && echo "CounselorAdmin/__init__.py 存在" || echo "CounselorAdmin/__init__.py 不存在"
test -f CounselorAdmin/apps.py && echo "CounselorAdmin/apps.py 存在" || echo "CounselorAdmin/apps.py 不存在"
```

5. **检查 Python 路径和当前工作目录**：
```bash
# 确保在项目根目录执行命令
cd /root/counselor/controller
pwd  # 应该显示 /root/counselor/controller

# 验证 manage.py 存在
test -f manage.py && echo "manage.py 存在" || echo "manage.py 不存在"

# 再次尝试执行迁移
python manage.py makemigrations
```

6. **如果使用 Git，检查 .gitignore 是否排除了应用目录**：
```bash
# 检查 .gitignore 文件
cat .gitignore | grep -E "Consultant|CounselorAdmin"

# 如果应用目录被忽略，需要临时取消忽略或直接上传
```

### 12.7 APIfox/Postman 无法访问服务器接口

**问题描述**：Django服务器已启动，但使用APIfox、Postman等工具无法访问接口。

**可能原因和解决方案**：

1. **服务器绑定地址错误（最常见）**：
   - ❌ 错误：`python manage.py runserver` - 默认绑定到 `127.0.0.1`，只能本机访问
   - ✅ 正确：`python manage.py runserver 0.0.0.0:8000` - 允许外部访问

   **解决方法**：
   ```bash
   # 停止当前服务器（Ctrl+C）
   # 使用正确的命令重新启动
   python manage.py runserver 0.0.0.0:8000
   ```

2. **防火墙未开放端口**：
   ```bash
   # Ubuntu/Debian (UFW)
   sudo ufw allow 8000/tcp
   sudo ufw status  # 查看防火墙状态
   
   # CentOS (firewalld)
   sudo firewall-cmd --permanent --add-port=8000/tcp
   sudo firewall-cmd --reload
   
   # 检查端口是否开放
   sudo netstat -tulpn | grep 8000
   ```

3. **云服务器安全组未配置**：
   - 登录云服务器控制台（阿里云、腾讯云等）
   - 进入安全组配置
   - 添加入站规则：允许 TCP 8000 端口
   - 源地址：`0.0.0.0/0`（测试环境）或指定IP（生产环境）

4. **使用错误的IP地址访问**：
   ```bash
   # 获取服务器公网IP
   curl ifconfig.me
   
   # 在APIfox中使用：http://<公网IP>:8000
   # 例如：http://47.xxx.xxx.xxx:8000
   ```

5. **检查服务器是否正在监听**：
   ```bash
   # 检查8000端口是否被监听
   sudo netstat -tulpn | grep 8000
   # 或
   sudo ss -tulpn | grep 8000
   
   # 应该看到类似输出：
   # tcp  0  0  0.0.0.0:8000  0.0.0.0:*  LISTEN  <PID>/python
   ```

6. **测试服务器本机访问**：
   ```bash
   # 在服务器上测试
   curl http://127.0.0.1:8000
   # 或
   curl http://localhost:8000
   
   # 如果本机可以访问，说明服务器正常，问题在外部访问配置
   ```

7. **检查 ALLOWED_HOSTS 配置**：
   - 确认 `DjangoProject/settings.py` 中 `ALLOWED_HOSTS = ['*']`（测试环境）
   - 或添加服务器IP：`ALLOWED_HOSTS = ['your-server-ip']`

**完整排查步骤**：
```bash
# 1. 确认使用正确的启动命令
python manage.py runserver 0.0.0.0:8000

# 2. 获取服务器IP
curl ifconfig.me

# 3. 检查防火墙
sudo ufw status  # Ubuntu/Debian
sudo firewall-cmd --list-all  # CentOS

# 4. 检查端口监听
sudo netstat -tulpn | grep 8000

# 5. 测试本机访问
curl http://127.0.0.1:8000

# 6. 在APIfox中使用：http://<公网IP>:8000/api/your-endpoint/
```

### 12.8 OperationalError: no such table: xxx

**问题描述**：访问API接口时出现 `OperationalError: no such table: xxx` 错误，例如 `no such table: verification_codes`。

**原因**：数据库迁移未执行或未完全执行，导致数据库表未创建。

**诊断步骤**：

首先检查迁移状态和应用是否被识别：

```bash
# 1. 检查迁移状态
python manage.py showmigrations

# 如果只看到 Django 内置应用（admin, auth, contenttypes, sessions），
# 而没有看到 Consultant 和 CounselorAdmin，说明应用未被识别

# 2. 检查应用目录和迁移文件是否存在
ls -la Consultant/migrations/
ls -la CounselorAdmin/migrations/

# 应该看到 __init__.py 和 0001_initial.py 等迁移文件
```

**如果 `showmigrations` 中没有显示 `Consultant` 和 `CounselorAdmin`**：

1. **检查应用目录是否完整**：
```bash
# 检查关键文件是否存在
test -f Consultant/__init__.py && echo "✓ Consultant/__init__.py 存在" || echo "✗ Consultant/__init__.py 不存在"
test -f Consultant/apps.py && echo "✓ Consultant/apps.py 存在" || echo "✗ Consultant/apps.py 不存在"
test -f Consultant/migrations/__init__.py && echo "✓ Consultant/migrations/__init__.py 存在" || echo "✗ Consultant/migrations/__init__.py 不存在"
test -f CounselorAdmin/__init__.py && echo "✓ CounselorAdmin/__init__.py 存在" || echo "✗ CounselorAdmin/__init__.py 不存在"
test -f CounselorAdmin/apps.py && echo "✓ CounselorAdmin/apps.py 存在" || echo "✗ CounselorAdmin/apps.py 不存在"
test -f CounselorAdmin/migrations/__init__.py && echo "✓ CounselorAdmin/migrations/__init__.py 存在" || echo "✗ CounselorAdmin/migrations/__init__.py 不存在"
```

2. **如果迁移文件缺失，需要重新上传**：
```bash
# 在本地Windows PowerShell中执行（替换为实际服务器IP）
# 上传迁移文件目录
scp -r D:\github\SunnyCounselor\DjangoProject\Consultant\migrations root@your-server-ip:/root/counselor/controller/Consultant/
scp -r D:\github\SunnyCounselor\DjangoProject\CounselorAdmin\migrations root@your-server-ip:/root/counselor/controller/CounselorAdmin/
```

3. **验证 settings.py 配置**：
```bash
# 检查 INSTALLED_APPS 配置
grep -A 10 "INSTALLED_APPS" DjangoProject/settings.py

# 应该看到：
# 'CounselorAdmin.apps.CounseloradminConfig',
# 'Consultant.apps.ConsultantConfig',
```

4. **重新检查迁移状态**：
```bash
python manage.py showmigrations
# 现在应该能看到 Consultant 和 CounselorAdmin 的迁移
```

**解决方案**：

1. **执行数据库迁移**（最常见解决方案）：
```bash
# 进入项目根目录
cd /root/counselor/controller

# 激活虚拟环境（如果使用）
source venv/bin/activate

# 应用所有迁移，创建所有数据库表
python manage.py migrate

# 如果迁移成功，应该看到类似输出：
# Operations to perform:
#   Apply all migrations: admin, auth, contenttypes, Consultant, CounselorAdmin, sessions
# Running migrations:
#   Applying CounselorAdmin.0001_initial... OK
#   Applying Consultant.0001_initial... OK
#   ...
```

2. **检查迁移状态**：
```bash
# 查看哪些迁移已应用，哪些未应用
python manage.py showmigrations

# 应该看到所有迁移标记为 [X]（已应用）
# 如果看到 [ ]（未应用），需要执行 migrate
```

3. **如果迁移文件缺失，重新生成**：
```bash
# 为所有应用生成迁移文件
python manage.py makemigrations

# 然后应用迁移
python manage.py migrate
```

4. **验证表是否已创建**（SQLite）：
```bash
# 使用sqlite3命令行工具检查
sqlite3 db.sqlite3 ".tables"

# 或者检查特定表是否存在
sqlite3 db.sqlite3 ".schema verification_codes"
```

5. **如果数据库文件损坏或需要重置**（⚠️ 会删除所有数据）：
```bash
# 备份现有数据库（如果有重要数据）
cp db.sqlite3 db.sqlite3.backup

# 删除数据库文件
rm db.sqlite3

# 重新执行迁移
python manage.py migrate

# 重新创建超级管理员（如果需要）
python manage.py createsuperuser
```

6. **检查应用是否正确注册**：
```bash
# 确认 settings.py 中 INSTALLED_APPS 包含两个应用
# 应该看到：
# 'CounselorAdmin.apps.CounseloradminConfig',
# 'Consultant.apps.ConsultantConfig',
```

**常见缺失的表及其所属应用**：
- `verification_codes` → `CounselorAdmin` 应用
- `consultation_orders` → `Consultant` 应用
- `counselor_profiles` → `Consultant` 应用
- `admin_users` → `CounselorAdmin` 应用

**完整修复步骤**：
```bash
# 1. 进入项目目录
cd /root/counselor/controller

# 2. 激活虚拟环境
source venv/bin/activate

# 3. 检查应用目录和迁移文件
ls -la Consultant/migrations/
ls -la CounselorAdmin/migrations/

# 4. 检查迁移状态
python manage.py showmigrations

# 如果看不到 Consultant 和 CounselorAdmin，检查：
# - 应用目录是否完整
# - 迁移文件是否存在
# - settings.py 中 INSTALLED_APPS 配置是否正确

# 5. 应用所有迁移
python manage.py migrate

# 6. 再次检查迁移状态（应该看到所有迁移标记为 [X]）
python manage.py showmigrations

# 7. 验证表已创建
sqlite3 db.sqlite3 ".tables" | grep -E "verification_codes|consultation_orders|counselor_profiles"

# 8. 重启服务器
python manage.py runserver 0.0.0.0:8000
```

**如果迁移文件缺失的完整修复流程**：

```bash
# 步骤1：在本地Windows PowerShell中上传迁移文件
# scp -r D:\github\SunnyCounselor\DjangoProject\Consultant\migrations root@your-server-ip:/root/counselor/controller/Consultant/
# scp -r D:\github\SunnyCounselor\DjangoProject\CounselorAdmin\migrations root@your-server-ip:/root/counselor/controller/CounselorAdmin/

# 步骤2：在服务器上验证
cd /root/counselor/controller
ls -la Consultant/migrations/
ls -la CounselorAdmin/migrations/

# 步骤3：确保迁移目录有 __init__.py
test -f Consultant/migrations/__init__.py || touch Consultant/migrations/__init__.py
test -f CounselorAdmin/migrations/__init__.py || touch CounselorAdmin/migrations/__init__.py

# 步骤4：检查应用是否被识别
python manage.py showmigrations

# 步骤5：执行迁移
python manage.py migrate

# 步骤6：验证表已创建
sqlite3 db.sqlite3 ".tables"
```

## 十三、部署检查清单

- [ ] Python 3.8+ 已安装
- [ ] **项目代码已上传到服务器**（见第三章）
- [ ] **`Consultant/` 应用目录已上传**（必需）
- [ ] **`CounselorAdmin/` 应用目录已上传**（必需）
- [ ] 虚拟环境已创建并激活
- [ ] 所有依赖包已安装 (`pip install -r requirements.txt`)
- [ ] 应用目录结构验证通过（`__init__.py`, `apps.py`, `models.py` 等文件存在）
- [ ] 数据库迁移已执行 (`python manage.py migrate`)
- [ ] 所有静态文件目录已创建 (`static/interview_form`, `static/referral_image`, `static/article_video`, `static/banner_photo`)
- [ ] 目录权限已设置正确
- [ ] `ALLOWED_HOSTS` 已配置（测试环境可使用 `['*']`）
- [ ] CORS配置已完成
- [ ] Gunicorn已安装并配置（生产环境）
- [ ] systemd服务已配置并启动（生产环境）
- [ ] Nginx已配置并启动（生产环境）
- [ ] 防火墙端口已开放（80, 443, 8000）
- [ ] SSL证书已配置（生产环境）
- [ ] 日志目录已创建
- [ ] 服务可以正常启动
- [ ] API接口可以正常访问
- [ ] 文件上传功能正常
- [ ] 静态文件可以正常访问

## 十四、更新和维护

### 14.1 更新代码

```bash
# 拉取最新代码（如果使用Git）
git pull

# 更新依赖
pip install -r requirements.txt

# 执行数据库迁移
python manage.py migrate

# 重启服务
sudo systemctl restart django-counselor
```

### 14.2 备份数据库

```bash
# SQLite备份
cp db.sqlite3 db.sqlite3.backup.$(date +%Y%m%d_%H%M%S)

# PostgreSQL备份
pg_dump -U username -d dbname > backup_$(date +%Y%m%d_%H%M%S).sql

# MySQL备份
mysqldump -u username -p dbname > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 14.3 定期维护任务

1. **清理旧的上传文件**（根据需要）
2. **数据库备份**（建议每天）
3. **日志轮转**（防止日志文件过大）
4. **更新依赖包**（定期检查安全更新）
5. **监控服务器资源**（CPU、内存、磁盘）

## 十五、 测试数据

### 基本用法（使用默认值）
`python manage.py generate_test_data`
咨询师ID：2（默认）
每个表生成：100条数据（默认）
### 自定义参数
```cmd
# 指定咨询师ID和生成数量
python manage.py generate_test_data --counselor-id 2 --count 100
# 只指定生成数量
python manage.py generate_test_data --count 50
# 只指定咨询师ID
python manage.py generate_test_data --counselor-id 2
```



