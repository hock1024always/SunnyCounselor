# 服务器部署文档

本文档详细说明如何在服务器上部署和配置心理咨询管理系统。

## 一、环境要求

### 1.1 系统要求
- **操作系统**: Linux (Ubuntu 20.04/22.04 推荐) 或 CentOS 7+
- **Python版本**: Python 3.8 或更高版本 (推荐 Python 3.9+)
- **数据库**: SQLite3 (默认) 或 PostgreSQL/MySQL (生产环境推荐)

### 1.2 Python依赖
所有依赖包已列在 `requirements.txt` 文件中，包括：
- Django 4.2.7
- Django REST Framework 3.14.0
- django-cors-headers 4.3.1
- pandas, openpyxl (用于Excel文件处理)
- Pillow (用于图片处理)
- 其他依赖项

## 二、服务器环境配置

### 2.1 安装Python和pip

```bash
# Ubuntu/Debian系统
sudo apt update
sudo apt install python3 python3-pip python3-venv -y

# CentOS系统
sudo yum install python3 python3-pip -y
```

### 2.2 创建Python虚拟环境（推荐）

```bash
# 进入项目目录
cd /path/to/DjangoProject

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows (如果需要在Windows服务器上部署)
```

### 2.3 安装项目依赖

```bash
# 确保在虚拟环境中
pip install --upgrade pip
pip install -r requirements.txt
```

## 三、项目代码部署

### 3.1 重要说明

**Django项目不需要编译，直接上传源代码即可。**

项目使用Python解释型语言，服务器上的Python环境会直接运行源代码，无需预先编译。

### 3.2 上传项目代码到服务器

有多种方式可以将项目代码上传到服务器，推荐使用以下方法：

#### 方法一：使用Git（推荐）

如果项目已托管到Git仓库（如GitHub、GitLab等），在服务器上直接克隆：

```bash
# 进入目标目录（如 /root/counselor/controller）
cd /root/counselor/controller

# 克隆项目（替换为实际的仓库地址）
git clone <your-repository-url> .

# 或者如果已有目录，进入后克隆
# cd /root/counselor/controller
# git clone <your-repository-url> temp
# mv temp/* temp/.* . 2>/dev/null || true
# rmdir temp
```

#### 方法二：使用SCP命令（从本地Windows上传）

在本地Windows PowerShell或CMD中执行：

```powershell
# 使用SCP上传整个项目目录
# 语法：scp -r <本地目录> <用户名>@<服务器IP>:<目标路径>

# 示例（替换为实际值）
scp -r D:\github\SunnyCounselor\DjangoProject\* root@your-server-ip:/root/counselor/controller/
```

如果使用SSH密钥，需要指定密钥路径：
```powershell
scp -i C:\path\to\your\key.pem -r D:\github\SunnyCounselor\DjangoProject\* root@your-server-ip:/root/counselor/controller/
```

#### 方法三：使用FTP/SFTP工具

使用WinSCP、FileZilla等图形化工具上传项目文件。

**上传时需要包含以下文件和目录：**
- `manage.py` - Django项目管理脚本（必需）
- `requirements.txt` - Python依赖列表（必需）
- `DjangoProject/` - 项目主配置目录（必需）
- `CounselorAdmin/` - 应用目录（必需）
- `templates/` - 模板文件目录（如果存在）
- `static/` - 静态文件目录（如果本地已有文件需要上传）
- `.git/` - Git仓库目录（可选，如果使用Git）

**不需要上传的内容：**
- `venv/` - 虚拟环境（在服务器上重新创建）
- `__pycache__/` - Python缓存文件（可忽略）
- `*.pyc` - Python编译文件（可忽略）
- `db.sqlite3` - 本地数据库文件（服务器上会创建新的）
- `.idea/` - IDE配置文件（可忽略）
- `counselor/` - 本地虚拟环境目录（可忽略）

### 3.3 验证项目文件结构

上传完成后，在服务器上验证项目结构：

```bash
# 进入项目目录
cd /root/counselor/controller

# 查看项目文件
ls -la

# 应该能看到以下关键文件/目录：
# - manage.py
# - requirements.txt
# - DjangoProject/
# - CounselorAdmin/
# - static/（如果已创建）
# - templates/（如果已创建）
# - venv/（虚拟环境）
```

**检查关键文件是否存在：**
```bash
# 检查manage.py
ls -l manage.py

# 检查项目配置目录
ls -la DjangoProject/

# 检查应用目录
ls -la CounselorAdmin/
```

### 3.4 项目目录权限设置

确保项目文件有正确的权限：

```bash
# 进入项目根目录
cd /root/counselor/controller

# 设置项目文件权限（可读可执行）
find . -type f -name "*.py" -exec chmod 644 {} \;
find . -type f -name "manage.py" -exec chmod 755 {} \;

# 设置目录权限
find . -type d -exec chmod 755 {} \;
```

### 3.5 常见问题

**问题1：上传后发现缺少某些文件**
- 检查本地项目目录是否完整
- 确认上传时使用了递归选项（`-r`）
- 检查是否有文件被.gitignore排除（如需要，可临时取消忽略）

**问题2：上传后文件权限不正确**
- 使用 `chmod` 命令修正权限（见3.4节）

**问题3：上传了不需要的 `__pycache__` 缓存目录**
- `__pycache__` 目录是Python自动生成的缓存，可以安全删除：
```bash
# 进入项目根目录
cd /root/counselor/controller

# 删除所有 __pycache__ 目录和 .pyc 文件
find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete
find . -type f -name "*.pyo" -delete

# 验证是否已删除
find . -name "__pycache__" -o -name "*.pyc"
# 如果没有输出，说明已全部删除
```
- **注意**：删除这些文件不会影响项目运行，Python会在运行时自动重新生成

**问题4：项目文件太大，上传慢**
- 可以先压缩项目文件，上传后再解压：
```bash
# 本地压缩（排除不需要的文件）
# 在项目根目录（DjangoProject目录的父目录）执行
cd D:\github\SunnyCounselor
tar -czf project.tar.gz --exclude='venv' --exclude='__pycache__' --exclude='*.pyc' --exclude='.git' --exclude='counselor' --exclude='db.sqlite3' DjangoProject/

# 上传压缩包
scp project.tar.gz root@your-server-ip:/root/counselor/controller/

# 服务器上解压
cd /root/counselor/controller
tar -xzf project.tar.gz
# 解压后文件会在DjangoProject目录中，需要移动到当前目录
mv DjangoProject/* . 2>/dev/null || true
rmdir DjangoProject 2>/dev/null || true
```

**或者使用Windows的压缩工具：**
- 使用7-Zip或WinRAR压缩项目目录（排除不需要的文件）
- 使用WinSCP等工具上传压缩包
- 在服务器上使用 `unzip` 或 `tar -xzf` 解压

## 四、项目配置

### 4.1 配置数据库

#### SQLite3 (默认，开发测试环境)
无需额外配置，Django会自动创建 `db.sqlite3` 文件。

#### PostgreSQL (生产环境推荐)
如需使用PostgreSQL，修改 `DjangoProject/settings.py`:

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'your_db_name',
        'USER': 'your_db_user',
        'PASSWORD': 'your_db_password',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
```

安装PostgreSQL适配器：
```bash
pip install psycopg2-binary
```

#### MySQL (可选)
如需使用MySQL，修改 `DjangoProject/settings.py`:

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'your_db_name',
        'USER': 'your_db_user',
        'PASSWORD': 'your_db_password',
        'HOST': 'localhost',
        'PORT': '3306',
    }
}
```

安装MySQL适配器：
```bash
pip install mysqlclient
```

### 4.2 执行数据库迁移

```bash
# 创建迁移文件（如果还没有）
python manage.py makemigrations

# 应用迁移
python manage.py migrate
```

### 4.3 创建超级管理员账户（可选）

```bash
python manage.py createsuperuser
```

## 五、静态文件和上传文件目录配置

### 5.1 重要目录说明

项目使用两个目录来管理静态资源：

1. **`static/` 目录**（`STATICFILES_DIRS`）:
   - 用于存储**上传的文件**（用户上传的图片、视频、Excel等）
   - 包含以下子目录：
     - `static/interview_form/` - 批量导入的访谈记录Excel文件
     - `static/referral_image/` - 转介管理的图片文件
     - `static/article_video/` - 教育管理的视频文件
     - `static/banner_photo/` - 轮播图图片文件
   - **注意**: 这个目录需要在服务器上手动创建并确保有写权限

2. **`staticfiles/` 目录**（`STATIC_ROOT`）:
   - 用于Django收集静态文件（`collectstatic`命令）
   - 生产环境通过Nginx等服务直接提供静态文件服务

### 5.2 创建必要的目录

```bash
# 进入项目根目录
cd /path/to/DjangoProject

# 创建static目录（如果不存在）
mkdir -p static

# 创建各个上传文件子目录
mkdir -p static/interview_form
mkdir -p static/referral_image
mkdir -p static/article_video
mkdir -p static/banner_photo
mkdir -p templates  # 模板文件目录（已存在可跳过）

# 设置目录权限（确保Django进程有写权限）
chmod -R 755 static
chmod -R 755 templates

# 如果使用特定的用户运行Django，设置所有权
# sudo chown -R www-data:www-data static templates  # Ubuntu/Debian
# sudo chown -R nginx:nginx static templates  # CentOS
```

### 5.3 收集静态文件（生产环境）

```bash
# 收集静态文件到staticfiles目录（用于Nginx等Web服务器）
python manage.py collectstatic --noinput
```

## 六、CORS和ALLOWED_HOSTS配置

### 6.1 当前配置说明

为了便于前端测试，当前配置已设置为：

```python
# settings.py

# 允许所有主机访问
ALLOWED_HOSTS = ['*']

# CORS配置 - 允许所有来源
CORS_ALLOW_ALL_ORIGINS = True
CORS_ALLOW_METHODS = ['DELETE', 'GET', 'OPTIONS', 'PATCH', 'POST', 'PUT']
```

### 6.2 生产环境安全建议

**⚠️ 安全警告**: 当前配置允许所有IP访问，仅适用于测试环境。

生产环境建议：

```python
# 限制允许的主机
ALLOWED_HOSTS = ['your-domain.com', 'www.your-domain.com', 'your-server-ip']

# 限制CORS来源
CORS_ALLOW_ALL_ORIGINS = False
CORS_ALLOWED_ORIGINS = [
    "https://your-frontend-domain.com",
    "http://localhost:3000",  # 开发环境
]
```

## 七、运行项目

### 7.1 开发模式运行

```bash
# 激活虚拟环境（如果使用）
source venv/bin/activate

# 运行开发服务器（仅用于测试）
python manage.py runserver 0.0.0.0:8000

# 或者指定端口
python manage.py runserver 0.0.0.0:8001
```

### 7.2 生产环境部署（使用Gunicorn）

#### 7.2.1 安装Gunicorn

```bash
pip install gunicorn
```

#### 7.2.2 创建Gunicorn配置文件

创建 `gunicorn_config.py`:

```python
# gunicorn_config.py
bind = "0.0.0.0:8000"
workers = 4
worker_class = "sync"
worker_connections = 1000
timeout = 30
keepalive = 2
max_requests = 1000
max_requests_jitter = 50
```

#### 7.2.3 使用Gunicorn启动

```bash
# 直接运行
gunicorn DjangoProject.wsgi:application -c gunicorn_config.py

# 或使用systemd管理（见下方）
```

### 7.3 使用systemd管理服务（推荐）

#### 7.3.1 创建systemd服务文件

创建 `/etc/systemd/system/django-counselor.service`:

```ini
[Unit]
Description=Django Counselor Admin Service
After=network.target

[Service]
Type=notify
User=www-data  # 替换为实际运行用户
Group=www-data  # 替换为实际运行组
WorkingDirectory=/path/to/DjangoProject
Environment="PATH=/path/to/DjangoProject/venv/bin"
ExecStart=/path/to/DjangoProject/venv/bin/gunicorn DjangoProject.wsgi:application -c /path/to/DjangoProject/gunicorn_config.py
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

#### 7.3.2 启动和管理服务

```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start django-counselor

# 设置开机自启
sudo systemctl enable django-counselor

# 查看服务状态
sudo systemctl status django-counselor

# 查看日志
sudo journalctl -u django-counselor -f
```

## 八、Nginx配置（生产环境推荐）

### 8.1 安装Nginx

```bash
# Ubuntu/Debian
sudo apt install nginx -y

# CentOS
sudo yum install nginx -y
```

### 8.2 配置Nginx

创建 `/etc/nginx/sites-available/django-counselor` (Ubuntu/Debian) 或 `/etc/nginx/conf.d/django-counselor.conf` (CentOS):

```nginx
upstream django_app {
    server 127.0.0.1:8000;  # Gunicorn监听地址
    keepalive 64;
}

server {
    listen 80;
    server_name your-domain.com www.your-domain.com;  # 替换为实际域名

    # 客户端上传文件大小限制（根据需要调整）
    client_max_body_size 100M;

    # 静态文件服务（上传的文件）
    location /static/ {
        alias /path/to/DjangoProject/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Django收集的静态文件（如果使用了collectstatic）
    location /staticfiles/ {
        alias /path/to/DjangoProject/staticfiles/;
        expires 30d;
    }

    # 反向代理到Django应用
    location / {
        proxy_pass http://django_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        
        # WebSocket支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 8.3 启用配置并重启Nginx

```bash
# Ubuntu/Debian - 创建软链接
sudo ln -s /etc/nginx/sites-available/django-counselor /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 设置开机自启
sudo systemctl enable nginx
```

## 九、防火墙配置

### 9.1 Ubuntu/Debian (UFW)

```bash
# 允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 如果直接使用Django开发服务器（不推荐生产环境）
sudo ufw allow 8000/tcp

# 启用防火墙
sudo ufw enable
```

### 9.2 CentOS (firewalld)

```bash
# 允许HTTP和HTTPS
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https

# 如果直接使用Django开发服务器
sudo firewall-cmd --permanent --add-port=8000/tcp

# 重新加载防火墙规则
sudo firewall-cmd --reload
```

## 十、SSL/HTTPS配置（生产环境必需）

### 10.1 使用Let's Encrypt免费证书

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y  # Ubuntu/Debian
sudo yum install certbot python3-certbot-nginx -y  # CentOS

# 获取证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 自动续期测试
sudo certbot renew --dry-run
```

## 十一、日志管理

### 11.1 Django日志配置

在 `DjangoProject/settings.py` 中添加日志配置（生产环境推荐）：

```python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'logs', 'django.log'),
            'formatter': 'verbose',
        },
        'error_file': {
            'level': 'ERROR',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'logs', 'django_error.log'),
            'formatter': 'verbose',
        },
    },
    'root': {
        'handlers': ['file', 'error_file'],
        'level': 'INFO',
    },
    'loggers': {
        'django': {
            'handlers': ['file', 'error_file'],
            'level': 'INFO',
            'propagate': False,
        },
    },
}
```

创建日志目录：
```bash
mkdir -p logs
chmod 755 logs
```

### 11.2 日志查看

```bash
# Django应用日志
tail -f /path/to/DjangoProject/logs/django.log
tail -f /path/to/DjangoProject/logs/django_error.log

# Nginx访问日志
tail -f /var/log/nginx/access.log

# Nginx错误日志
tail -f /var/log/nginx/error.log

# systemd服务日志
sudo journalctl -u django-counselor -f
```

## 十二、常见问题排查

### 12.1 静态文件无法访问

1. 检查目录权限：
```bash
ls -la static/
chmod -R 755 static/
```

2. 检查Nginx配置中的路径是否正确

3. 检查URL配置是否正确加载了静态文件路由

### 12.2 CORS跨域问题

1. 确认 `django-cors-headers` 已安装：`pip list | grep django-cors-headers`

2. 确认中间件配置正确（在 `settings.py` 中）

3. 检查CORS配置是否允许了前端域名

### 12.3 文件上传失败

1. 检查上传目录是否存在且有写权限：
```bash
ls -la static/referral_image/
chmod -R 755 static/
```

2. 检查Nginx的 `client_max_body_size` 设置

3. 检查Django的 `FILE_UPLOAD_MAX_MEMORY_SIZE` 设置（默认2.5MB）

### 12.4 数据库连接问题

1. 检查数据库文件权限（SQLite）：
```bash
chmod 664 db.sqlite3
chmod 775 .  # 目录权限
```

2. PostgreSQL/MySQL连接问题：检查用户名、密码、主机、端口

### 12.5 端口被占用

```bash
# 查找占用端口的进程
sudo lsof -i :8000
sudo netstat -tulpn | grep 8000

# 杀死进程
sudo kill -9 <PID>
```

## 十三、部署检查清单

- [ ] Python 3.8+ 已安装
- [ ] **项目代码已上传到服务器**（见第三章）
- [ ] 虚拟环境已创建并激活
- [ ] 所有依赖包已安装 (`pip install -r requirements.txt`)
- [ ] 数据库迁移已执行 (`python manage.py migrate`)
- [ ] 所有静态文件目录已创建 (`static/interview_form`, `static/referral_image`, `static/article_video`, `static/banner_photo`)
- [ ] 目录权限已设置正确
- [ ] `ALLOWED_HOSTS` 已配置（测试环境可使用 `['*']`）
- [ ] CORS配置已完成
- [ ] Gunicorn已安装并配置（生产环境）
- [ ] systemd服务已配置并启动（生产环境）
- [ ] Nginx已配置并启动（生产环境）
- [ ] 防火墙端口已开放（80, 443, 8000）
- [ ] SSL证书已配置（生产环境）
- [ ] 日志目录已创建
- [ ] 服务可以正常启动
- [ ] API接口可以正常访问
- [ ] 文件上传功能正常
- [ ] 静态文件可以正常访问

## 十四、更新和维护

### 14.1 更新代码

```bash
# 拉取最新代码（如果使用Git）
git pull

# 更新依赖
pip install -r requirements.txt

# 执行数据库迁移
python manage.py migrate

# 重启服务
sudo systemctl restart django-counselor
```

### 14.2 备份数据库

```bash
# SQLite备份
cp db.sqlite3 db.sqlite3.backup.$(date +%Y%m%d_%H%M%S)

# PostgreSQL备份
pg_dump -U username -d dbname > backup_$(date +%Y%m%d_%H%M%S).sql

# MySQL备份
mysqldump -u username -p dbname > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 14.3 定期维护任务

1. **清理旧的上传文件**（根据需要）
2. **数据库备份**（建议每天）
3. **日志轮转**（防止日志文件过大）
4. **更新依赖包**（定期检查安全更新）
5. **监控服务器资源**（CPU、内存、磁盘）

## 十五、联系和支持

如有部署问题，请参考：
- Django官方文档：https://docs.djangoproject.com/
- Django REST Framework文档：https://www.django-rest-framework.org/
- Nginx文档：https://nginx.org/en/docs/

---

**最后更新**: 2025-01-XX
**版本**: 1.0

