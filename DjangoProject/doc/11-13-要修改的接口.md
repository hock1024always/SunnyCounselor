# 管理端

## 1. 访谈评估

### api/admin/interview/records/profile 获取咨询档案的详细咨询记录

返回参数字段`crisisStatus`的类型修改为 array[string]

------

### api/admin/interview/records/profile/create 新建一条咨询记录

请求参数字段`crisisStatus`的类型修改为 array[string]

------

# 咨询师端

## 1. 咨询列表

### api/consultant/orders 获取咨询列表

返回数据的data中补充name字段，即来访者的名字





## 2. 咨询档案

### api/consultant/interview/records 获取咨询档案列表

该请求失败，响应码为500，服务器出问题了

```json
{
    "userID": 1,
    "token": "1b3a69b2-6fcc-45e3-99cf-5de6136bd6e4",
    "page": 1,
    "page_size": 10,
    "std_name": "",
    "std_grade": "",
    "std_class": "",
    "std_school": "",
    "interview_count": "",
    "interview_status": "",
    "interview_type": "",
    "doctor_evaluation": "",
    "follow_up_plan": ""
}
```

------

### api/consultant/interview/records/profile 获取咨询档案的详细咨询记录

返回参数字段`crisisStatus`的类型修改为 array[string]

-------

### api/consultant/interview/records/profile/create 新建一条咨询记录

请求参数字段`crisisStatus`的类型修改为 array[string]

-------

### api/consultant/interview/records/profile/update 更新一条咨询记录

请求参数字段

* `crisisStatus`的类型修改为 array[string]

* `signatureImage`的类型修改为 file

* `attachImages`的类型修改为 file

------

## 3. 排班管理

### api/consultant/schedule/work 按年月份获取排班管理信息

* 请求失败，响应码为500

* apifox中修改返回参数的work_time的类型为 array[string]

------

### api/consultant/schedule/stop 获取停诊信息

apifox中返回参数补充字段：total, id和reason，具体看apifox

```
{
  "user_id": 0,
  "token": "string",
  "page": 0,
  "page_size": 0,
  "name": "string",
  "start_time": "string",
  "end_time": "string"
}
```

```
{
  "code": 0,
  "message": "string",
  "total": "string",
  "data": [
    {
      "id": "string",
      "name": "string",
      "start_time": "string",
      "end_time": "string",
      "reason": "string"
    }
  ]
}
```

## 4. 补充：咨询师端 我的评论页面

apifox漏写一个页面的接口，该页面目前只有查询接口，具体看apifox

api/consultant/comments

请求字段

```
{
  "user_id": 0,
  "token": "string",
  "page": 0,
  "page_size": 0
}
```

响应字段

```
{
  "code": 0,
  "message": "string",
  "total": 0,
  "data": [
    {
      "id": "string",
      "avatar": "string",
      "username": "string",
      "name": "string",
      "organization": "string",
      "time": "string",
      "content": "string",
      "rating": 0
    }
  ]
}
```

---

# 修改记录

## 管理端修改

### 1. api/admin/interview/records/profile 获取咨询档案的详细咨询记录

**修改内容：**
- 返回参数字段 `crisisStatus` 的类型从 `string` 修改为 `array[string]`

**请求：**
```json
{
  "user_id": 3,
  "token": "string",
  "id": 1
}
```

**响应：**
```json
{
  "code": 0,
  "message": "string",
  "data": [
    {
      "id": 0,
      "count": "string",
      "name": "string",
      "gender": "string",
      "studentId": "string",
      "school": "string",
      "grade": "string",
      "class": "string",
      "date": "string",
      "time": "string",
      "duration": "string",
      "visitStatus": "string",
      "description": "string",
      "doctorEvaluation": "string",
      "followUpPlan": "string",
      "nextVisitPlan": "string",
      "crisisStatus": ["string"],  // 修改为数组类型
      "consultantName": "string",
      "signatureImage": "string",
      "attachImage": "string",
      "isThirdPartyEvaluation": true
    }
  ]
}

"crisisStatus": [
                "低风险"
            ],
```

**实现说明：**
- 在序列化器 `ConsultationSessionDetailSerializer` 中将 `crisisStatus` 改为 `SerializerMethodField`
- 添加 `get_crisisStatus` 方法，将数据库中的字符串（JSON格式）解析为数组返回

---

### 2. api/admin/interview/records/profile/create 新建一条咨询记录(未创建示例)

**修改内容：**

- 请求参数字段 `crisisStatus` 的类型从 `string` 修改为 `array[string]`

**请求：**

```
id: 1
date: 2024-12-13
time: 14:00
duration: 60
visitStatus: completed
description: 测试描述
doctorEvaluation: 测试评定
followUpPlan: 测试计划
nextVisitPlan: 测试下次计划
crisisStatus: ["中风险", "高风险"]  // 或 "中风险,高风险" 或 "中风险"
consultantName: 张医生
isThirdPartyEvaluation: true
signatureImage: [文件]
attachImages: [文件1, 文件2]
```



```json
{
  "user_id": "string",
  "token": "string",
  "id": "string",
  "count": "string",
  "name": "string",
  "gender": "string",
  "studentId": "string",
  "school": "string",
  "grade": "string",
  "class": "string",
  "date": "string",
  "time": "string",
  "duration": "string",
  "visitStatus": "string",
  "description": "string",
  "doctorEvaluation": "string",
  "followUpPlan": "string",
  "nextVisitPlan": "string",
  "crisisStatus": ["string"],  // 修改为数组类型
  "consultantName": "string",
  "isThirdPartyEvaluation": "string",
  "signatureImage": "file",
  "attachImages": "file"
}
```

**响应：**
```json
{
  "code": "0",
  "message": "string"
}
```

**实现说明：**
- 在视图函数中添加 `_convert_crisis_status_to_string` 辅助函数
- 将前端传入的数组转换为JSON字符串存储到数据库

---

## 咨询师端修改

### 1. api/consultant/orders 获取咨询列表

**修改内容：**
- 返回数据的 `data` 中补充 `name` 字段（来访者的名字）

**请求：**
```json
{
  "user_id": 0,
  "token": "string",
  "page": 0,
  "pageSize": 10,
  "name": "string",
  "date_start": "string",
  "date_end": "string",
  "type": "string",
  "status": "string"
}
```

**响应：**
```json
{
  "code": 0,
  "message": "string",
  "data": {
    "total": 0,
    "data": [
      {
        "id": 0,
        "order_id": "string",
        "name": "string",  // 新增字段
        "gender": "string",
        "age": "string",
        "type": "string",
        "key_word": "string",
        "date": "string",
        "time": "string",
        "commit_time": "string",
        "finish_time": "string",
        "status": "string",
        "contact": "string"
      }
    ]
  }
}
```

**实现说明：**
- 在 `ConsultationOrderListSerializer` 中添加 `name` 字段
- 通过 `get_name` 方法从关联的 `record` 中获取 `client_name`

---

### 2. api/consultant/interview/records 获取咨询档案列表

**修改内容：**
- 修复500错误：添加参数类型验证和异常处理

**请求：**
```json
{
  "userID": 1,
  "token": "string",
  "page": 1,
  "page_size": 10,
  "std_name": "",
  "std_grade": "",
  "std_class": "",
  "std_school": "",
  "interview_count": "",
  "interview_status": "",
  "interview_type": "",
  "doctor_evaluation": "",
  "follow_up_plan": ""
}
```

**响应：**
```json
{
  "code": 0,
  "message": "string",
  "data": {
    "total": 0,
    "data": [
      {
        "id": 0,
        "std_name": "string",
        "std_grade": "string",
        "std_class": "string",
        "std_school": "string",
        "interview_count": "string",
        "interview_status": "string",
        "interview_type": "string",
        "doctor_evaluation": "string",
        "follow_up_plan": "string",
        "create_time": "string"
      }
    ]
  }
}
```

**实现说明：**
- 添加 `try-except` 块处理分页参数的类型转换
- 当参数类型错误时返回400错误而不是500错误

---

### 3. api/consultant/interview/records/profile 获取咨询档案的详细咨询记录

**修改内容：**
- 返回参数字段 `crisisStatus` 的类型从 `string` 修改为 `array[string]`

**请求：**
```json
{
  "user_id": 0,
  "token": "string",
  "id": 0
}
```

**响应：**
```json
{
  "code": 0,
  "message": "string",
  "data": [
    {
      "id": 0,
      "count": "string",
      "name": "string",
      "gender": "string",
      "studentId": "string",
      "school": "string",
      "grade": "string",
      "class": "string",
      "date": "string",
      "time": "string",
      "duration": "string",
      "visitStatus": "string",
      "description": "string",
      "doctorEvaluation": "string",
      "followUpPlan": "string",
      "nextVisitPlan": "string",
      "crisisStatus": ["string"],  // 修改为数组类型
      "consultantName": "string",
      "signatureImage": "string",
      "attachImage": "string",
      "isThirdPartyEvaluation": true
    }
  ]
}

"crisisStatus": [
                "中风险"
            ],
```

**实现说明：**

- 与管理端使用相同的序列化器，自动应用修改

---

### 4. api/consultant/interview/records/profile/create 新建一条咨询记录(未创建样例)

**修改内容：**
- 请求参数字段 `crisisStatus` 的类型从 `string` 修改为 `array[string]`

**请求：**
```json
{
  "user_id": 0,
  "token": "string",
  "record_id": 0,
  "count": "string",
  "name": "string",
  "gender": "string",
  "studentId": "string",
  "school": "string",
  "grade": "string",
  "class": "string",
  "date": "string",
  "time": "string",
  "duration": "string",
  "visitStatus": "string",
  "description": "string",
  "doctorEvaluation": "string",
  "followUpPlan": "string",
  "nextVisitPlan": "string",
  "crisisStatus": ["string"],  // 修改为数组类型
  "consultantName": "string",
  "isThirdPartyEvaluation": true,
  "signatureImage": "string",
  "attachImages": ["string"]
}
```

**响应：**
```json
{
  "code": 0,
  "message": "string"
}
```

**实现说明：**
- 在序列化器中将 `crisisStatus` 改为 `ListField`
- 在视图函数中使用 `_convert_crisis_status_to_string` 函数转换存储

---

### 5. api/consultant/interview/records/profile/update 更新一条咨询记录(未创建样例)

**修改内容：**
- 请求参数字段 `crisisStatus` 的类型从 `string` 修改为 `array[string]`
- 请求参数字段 `signatureImage` 的类型从 `string` 修改为 `file`
- 请求参数字段 `attachImages` 的类型从 `array[string]` 修改为 `file`（支持多文件上传）

**请求：**
```json
{
  "user_id": 0,
  "token": "string",
  "id": 0,
  "visitStatus": "string",
  "description": "string",
  "doctorEvaluation": "string",
  "followUpPlan": "string",
  "nextVisitPlan": "string",
  "crisisStatus": ["string"],  // 修改为数组类型
  "consultantName": "string",
  "isThirdPartyEvaluation": true,
  "signatureImage": "file",  // 修改为文件类型
  "attachImages": "file"  // 修改为文件类型（支持多文件）
}
```

**响应：**
```json
{
  "code": 0,
  "message": "string"
}
```

**实现说明：**
- 添加文件上传处理逻辑
- `signatureImage` 支持单文件上传，保存到 `static/session_signature/` 目录
- `attachImages` 支持多文件上传，保存到 `static/session_attach/` 目录
- 上传新文件时自动删除旧文件
- 文件类型限制为：jpg, jpeg, png, gif, bmp, webp

---

### 6. api/consultant/schedule/work 按年月份获取排班管理信息

**修改内容：**
- 修复500错误：添加参数验证和异常处理
- 返回参数的 `work_time` 的类型从 `string` 修改为 `array[string]`

**请求：**
```json
{
  "user_id": 0,
  "token": "string",
  "year": 2024,
  "month": 12,
  "organization": "string"
}
```

**响应：**
```json
{
  "code": 0,
  "message": "string",
  "data": [
    {
      "date": 1,
      "schedules": [
        {
          "id": 0,
          "name": "string",
          "work_time": ["string"]  // 修改为数组类型
        }
      ]
    }
  ]
}


//work_time
"work_time": [
                        {
                            "start": "09:00",
                            "end": "10:00",
                            "available": true
                        },
                        {
                            "start": "10:00",
                            "end": "11:00",
                            "available": true
                        },
                        {
                            "start": "14:00",
                            "end": "15:00",
                            "available": true
                        },
                        {
                            "start": "15:00",
                            "end": "16:00",
                            "available": true
                        }
```

**实现说明：**
- 添加年份和月份参数的类型验证
- 添加数据库查询的异常处理
- 将 `time_slots` 字段从字符串转换为数组返回

---

### 7. api/consultant/schedule/stop 获取停诊信息

**修改内容：**
- 返回参数补充字段：`total`, `id` 和 `reason`

**请求：**
```json
{
  "user_id": 0,
  "token": "string",
  "page": 0,
  "page_size": 0,
  "name": "string",
  "start_time": "string",
  "end_time": "string"
}
```

**响应：**
```json
{
  "code": 0,
  "message": "string",
  "total": "string",  // 新增字段
  "data": [
    {
      "id": "string",  // 新增字段
      "name": "string",
      "start_time": "string",
      "end_time": "string",
      "reason": "string"  // 新增字段
    }
  ]
}
```

**实现说明：**
- 在返回数据中添加 `total` 字段（总数）
- 在每个数据项中添加 `id` 和 `reason` 字段

---

### 8. api/consultant/comments 获取评论列表

**修改内容：**
- 修复URL路径：从 `api/consuntant/user/comments` 修改为 `api/consultant/comments`
- 支持两种参数名：`page_size` 和 `pageSize`
- 返回参数补充 `total` 字段
- `rating` 字段类型从 `string` 修改为 `number`

**请求：**
```json
{
  "user_id": 0,
  "token": "string",
  "page": 0,
  "page_size": 0  // 或 pageSize
}

```

**响应：**
```json
{
  "code": 0,
  "message": "string",
  "total": 0,  // 新增字段
  "data": [
    {
      "id": "string",
      "avatar": "string",
      "username": "string",
      "name": "string",
      "organization": "string",
      "time": "string",
      "content": "string",
      "rating": 0  // 修改为数字类型
    }
  ]
}
```

**实现说明：**
- 修复URL路径拼写错误
- 支持两种参数名以提高兼容性
- 返回总数用于分页
- `rating` 直接返回整数类型

---

## 备注

### crisisStatus 字段处理

1. **存储方式**：数据库中使用 `CharField` 存储，内容为JSON格式的字符串数组
2. **序列化**：在序列化器中通过 `SerializerMethodField` 将JSON字符串解析为数组返回
3. **反序列化**：在视图函数中使用 `_convert_crisis_status_to_string` 函数将数组转换为JSON字符串存储

### 文件上传处理

1. **文件存储位置**：
   - 签名图片：`static/session_signature/`
   - 附加图片：`static/session_attach/`
2. **文件命名规则**：`{类型}_{记录ID}_{时间戳}_{序号}.{扩展名}`
3. **文件类型限制**：jpg, jpeg, png, gif, bmp, webp
4. **旧文件清理**逻辑：上传新文件时自动删除对应的旧文件

### 错误处理改进

1. **兼容性**：支持多种参数名格式（如 `page_size` 和 `pageSize`）

---

## 修改文件

1. `Consultant/serializers/record.py` - 修改序列化器，支持crisisStatus数组
2. `Consultant/serializers/order.py` - 添加name字段
3. `Consultant/views/record.py` - 修改视图函数，支持crisisStatus数组和文件上传
4. `Consultant/views/schedule.py` - 修复500错误，修改work_time为数组
5. `Consultant/views/user.py` - 修复comments接口
6. `Consultant/urls.py` - 修复URL路径拼写错误
7. `CounselorAdmin/views/counseling.py` - 修改管理端接口，支持crisisStatus数组

---

