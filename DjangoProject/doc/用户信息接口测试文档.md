# 用户信息接口测试文档

## 接口说明

**接口地址**: `POST /user/info`

**鉴权方式**: 在请求体JSON中传递 `user_id` 和 `token`，验证数据库中用户ID和Token是否匹配

**注意**: 
- 使用 **POST** 方法
- **不需要在请求头设置任何鉴权信息**
- **不涉及路径参数**
- `user_id` 和 `token` 放在请求体的JSON中

---

## 数据库表结构

我们已经有了 `admin_auth_tokens` 表，结构如下：
- `user_id`: 用户ID（外键关联AdminUser）
- `token`: Token字符串
- `is_active`: 是否有效
- `expires_at`: 过期时间

---

## 测试步骤

### 第一步：登录获取Token

**接口**: `POST http://127.0.0.1:8000/counselor_admin/auth/login`

**请求Body**:
```json
{
    "email": "your_email@example.com",
    "password": "your_password",
    "captcha": "true"
}
```

**响应示例**:
```json
{
    "token": "619cf629-b84e-41a0-adca-42d07a3ddd0e",
    "id": "2"
}
```

**重要**: 保存返回的 `token` 和 `id` 值！

---

### 第二步：测试获取用户信息接口

**接口**: `POST http://127.0.0.1:8000/counselor_admin/user/info`

#### 在Apifox中的配置步骤：

1. **选择接口**: `POST /user/info`

2. **设置请求方法**: 
   - 确保方法是 **POST**

3. **设置URL**: 
   - `http://127.0.0.1:8000/counselor_admin/user/info`

4. **设置请求体**:
   - 点击 **Body** 标签页
   - 选择 **JSON** 格式
   - 在请求体中输入以下JSON：

```json
{
    "user_id": 2,
    "token": "619cf629-b84e-41a0-adca-42d07a3ddd0e"
}
```

**重要提示**:
- ❌ **不需要**在Headers中添加任何内容
- ❌ **不需要**路径参数
- ✅ **只需要**在Body的JSON中提供 `user_id` 和 `token`

5. **发送请求**: 点击发送按钮

---

## 响应示例

### 成功响应（200）

```json
{
    "user_info": {
        "user_name": "testuser",
        "email": "test@example.com",
        "phone": "13800138000"
    }
}
```

### 缺少参数（400）

```json
{
    "message": "缺少必要参数",
    "detail": "请在请求体JSON中提供 user_id 和 token 字段"
}
```

### 认证失败（401）

如果 `user_id` 和 `token` 在数据库中不匹配，或token已过期：

```json
{
    "message": "认证失败",
    "detail": "用户ID与Token不匹配或Token已过期"
}
```

### 用户不存在（404）

```json
{
    "message": "用户不存在"
}
```

---

## Apifox配置示例

### 完整配置步骤：

1. **打开接口**: `POST /user/info`
2. **设置方法**: 确保是 **POST** 方法
3. **设置URL**: `http://127.0.0.1:8000/counselor_admin/user/info`
4. **设置Body**: 
   - 选择 **Body** 标签页
   - 选择 **JSON** 格式
   - 输入JSON内容：
   ```json
   {
       "user_id": 2,
       "token": "619cf629-b84e-41a0-adca-42d07a3ddd0e"
   }
   ```
5. **Headers**: **不需要设置任何Headers**（保持默认即可）
6. **发送请求**

---

## 验证逻辑说明

1. **获取参数**: 从请求体JSON中获取 `user_id` 和 `token`
2. **数据库验证**: 查询 `admin_auth_tokens` 表，验证：
   - `user_id` 是否匹配
   - `token` 是否匹配
   - `is_active` 是否为 `True`
   - `expires_at` 是否未过期
3. **返回用户信息**: 如果所有验证通过，返回用户信息

---

## 注意事项

1. **Token获取**: 必须先通过登录接口获取有效的token和user_id
2. **请求方法**: 使用 **POST** 方法
3. **请求体格式**: 必须是JSON格式，包含 `user_id` 和 `token` 两个字段
4. **Headers**: **不需要设置任何Headers**，不要在Headers中添加鉴权信息
5. **路径参数**: **不需要路径参数**，URL固定为 `/user/info`
6. **Token有效期**: Token默认有效期为7天（在登录时设置）
7. **数据库存储**: Token存储在 `admin_auth_tokens` 表中，每次登录会创建新token并禁用旧token

---

## 完整测试示例

**请求**:
```
POST http://127.0.0.1:8000/counselor_admin/user/info
Content-Type: application/json

{
    "user_id": 2,
    "token": "619cf629-b84e-41a0-adca-42d07a3ddd0e"
}
```

**响应**（成功）:
```json
{
    "user_info": {
        "user_name": "testuser",
        "email": "test@example.com",
        "phone": "13800138000"
    }
}
```
